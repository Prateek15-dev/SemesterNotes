<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />
    <link rel="stylesheet" href="css/admin.css" />
    <script src="https://unpkg.com/@supabase/supabase-js"></script>
  </head>
  <body>
    <div class="admin-sidebar">
      <div class="sidebar-brand">
        <img src="../images/Book_Logo.jpg" alt="Logo" />
        <h5>Admin Portal</h5>
      </div>
      <ul class="nav flex-column">
        <li class="nav-item">
          <a class="nav-link active" href="#"
            ><i class="fas fa-home mr-2"></i>Dashboard</a
          >
        </li>
        <li class="nav-item mt-auto">
          <a class="nav-link text-danger" href="#" id="logoutBtn"
            ><i class="fas fa-sign-out-alt mr-2"></i>Logout</a
          >
        </li>
      </ul>
    </div>

    <div class="main-content">
      <div
        class="page-header d-flex justify-content-between align-items-center"
      >
        <h4>Dashboard Overview</h4>
        <div class="user-info">
          <span class="mr-2">Welcome, Admin</span>
          <img
            src="../images/Book_Logo.jpg"
            alt="Admin"
            class="rounded-circle"
            width="40"
          />
        </div>
      </div>

      <div class="row">
        <div class="col-md-8">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title mb-4">Upload Notes</h5>
              <form id="uploadForm" class="upload-form">
                <div class="form-group">
                  <label>Select Semester</label>
                  <select
                    class="form-control custom-select"
                    id="semester"
                    required
                  >
                    <option value="" disabled selected>
                      Select your semester
                    </option>
                    <optgroup label="First Year">
                      <option value="1">Semester 1</option>
                      <option value="2">Semester 2</option>
                    </optgroup>
                    <optgroup label="Second Year">
                      <option value="3">Semester 3</option>
                      <option value="4">Semester 4</option>
                    </optgroup>
                    <optgroup label="Third Year">
                      <option value="5">Semester 5</option>
                      <option value="6">Semester 6</option>
                    </optgroup>
                    <optgroup label="Final Year">
                      <option value="7">Semester 7</option>
                      <option value="8">Semester 8</option>
                    </optgroup>
                  </select>
                </div>
                <div class="form-group">
                  <label>Subject Name</label>
                  <input
                    type="text"
                    class="form-control"
                    id="subject"
                    required
                  />
                </div>
                <div class="form-group">
                  <label>Upload PDF</label>
                  <input
                    type="file"
                    class="form-control-file"
                    id="pdfFile"
                    accept=".pdf"
                    required
                  />
                </div>
                <button type="submit" class="btn btn-primary btn-custom">
                  <i class="fas fa-upload mr-2"></i>Upload Notes
                </button>
              </form>
            </div>
          </div>

          <div class="card mt-4">
            <div class="card-body">
              <h5 class="card-title mb-4">All Notes</h5>
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead>
                    <tr>
                      <th>Semester</th>
                      <th>Subject</th>
                      <th>File Name</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="notesList"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title mb-4">Recent Uploads</h5>
              <div id="recentUploads">
                <!-- Recent uploads will be displayed here -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const SUPABASE_URL = "https://ikpwcblawncfjgrtktbw.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlrcHdjYmxhd25jZmpncnRrdGJ3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY0NDUxMTQsImV4cCI6MjA2MjAyMTExNH0.F0zJj4J19DoKLMg7YL-s6oBkX18NUPpJEv0SAwsjhQI";

      const { createClient } = supabase;
      const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      async function initializeStorage() {
        try {
          const { data, error: bucketError } =
            await supabaseClient.storage.createBucket(
              "notes",
              { public: true, fileSizeLimit: 5242880 },
              { upsert: true }
            );

          if (bucketError && !bucketError.message.includes("already exists")) {
            throw bucketError;
          }
          showAlert("Storage initialized successfully", "success");
        } catch (error) {
          console.error("Storage initialization error:", error);
          showAlert(
            "Storage initialization failed: " + error.message,
            "danger"
          );
        }
      }

      async function loadAllNotes() {
        const notesList = document.getElementById("notesList");
        notesList.innerHTML =
          '<tr><td colspan="4" class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>';

        try {
          const { data, error } = await supabaseClient
            .from("notes_metadata")
            .select("*")
            .order("created_at", { ascending: false });

          if (error) throw error;

          notesList.innerHTML = "";

          if (!data || data.length === 0) {
            notesList.innerHTML =
              '<tr><td colspan="4" class="text-center">No notes found</td></tr>';
            return;
          }

          data.forEach((note) => {
            const row = document.createElement("tr");
            row.setAttribute("data-note-id", note.id);
            row.innerHTML = `
              <td class="align-middle">Semester ${note.semester}</td>
              <td class="align-middle">${note.subject.replace(/_/g, " ")}</td>
              <td class="align-middle">
                <div class="text-truncate" style="max-width: 200px;" title="${
                  note.file_name
                }">
                  ${note.file_name}
                </div>
              </td>
              <td class="align-middle">
                <div class="btn-group">
                  <button class="btn btn-sm btn-outline-primary mr-2" onclick="viewNote('${
                    note.file_path
                  }')">
                    <i class="fas fa-eye"></i> View
                  </button>
                  <button class="btn btn-sm btn-outline-danger" onclick="deleteNote('${
                    note.id
                  }', '${note.file_path}')">
                    <i class="fas fa-trash"></i> Delete
                  </button>
                </div>
              </td>
            `;
            notesList.appendChild(row);
          });
        } catch (error) {
          console.error("Failed to load notes:", error);
          notesList.innerHTML = `
            <tr>
              <td colspan="4" class="text-center text-danger">
                <i class="fas fa-exclamation-circle"></i> 
                Failed to load notes: ${error.message}
              </td>
            </tr>
          `;
        }
      }

      async function loadRecentUploads() {
        try {
          const { data, error } = await supabaseClient
            .from("notes_metadata")
            .select("*")
            .order("created_at", { ascending: false })
            .limit(5);

          if (error) throw error;

          const recentUploadsDiv = document.getElementById("recentUploads");
          recentUploadsDiv.innerHTML = "";

          if (!data || data.length === 0) {
            recentUploadsDiv.innerHTML =
              '<div class="text-muted">No recent uploads</div>';
            return;
          }

          data.forEach((note) => {
            const div = document.createElement("div");
            div.className = "upload-item mb-3 p-3 border rounded";
            div.setAttribute("data-note-id", note.id);
            div.innerHTML = `
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="mb-1">Semester ${note.semester}</h6>
                  <div class="text-muted">${note.subject.replace(
                    /_/g,
                    " "
                  )}</div>
                  <small class="text-muted">${note.file_name}</small>
                </div>
                <div class="btn-group">
                  <button class="btn btn-sm btn-outline-primary mr-1" onclick="viewNote('${
                    note.file_path
                  }')">
                    <i class="fas fa-eye"></i>
                  </button>
                  <button class="btn btn-sm btn-outline-danger" onclick="deleteNote('${
                    note.id
                  }', '${note.file_path}')">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </div>
            `;
            recentUploadsDiv.appendChild(div);
          });
        } catch (error) {
          console.error("Failed to load recent uploads:", error);
          document.getElementById("recentUploads").innerHTML =
            '<div class="text-danger">Failed to load recent uploads</div>';
        }
      }

      async function deleteNote(id, filePath) {
        if (!confirm("Are you sure you want to delete this note?")) return;

        try {
          // First delete from storage
          const { error: storageError } = await supabaseClient.storage
            .from("notes")
            .remove([filePath]);

          if (storageError) {
            console.error("Storage deletion error:", storageError);
            throw new Error("Failed to delete file from storage");
          }

          // Then delete from database
          const { error: dbError } = await supabaseClient
            .from("notes_metadata")
            .delete()
            .match({ id });

          if (dbError) {
            console.error("Database deletion error:", dbError);
            throw new Error("Failed to delete note from database");
          }

          // Update UI immediately after successful deletion
          const allNotesRow = document.querySelector(
            `tr[data-note-id="${id}"]`
          );
          const recentUploadDiv = document.querySelector(
            `div[data-note-id="${id}"]`
          );

          if (allNotesRow) allNotesRow.remove();
          if (recentUploadDiv) recentUploadDiv.remove();

          // Check and update empty states
          updateEmptyStates();
          showAlert("Note deleted successfully!", "success");
        } catch (error) {
          console.error("Delete operation failed:", error);
          showAlert(`Failed to delete note: ${error.message}`, "danger");
        }
      }

      // Add helper function for empty states
      function updateEmptyStates() {
        const notesList = document.getElementById("notesList");
        const recentUploads = document.getElementById("recentUploads");

        if (!notesList.children.length) {
          notesList.innerHTML =
            '<tr><td colspan="4" class="text-center">No notes found</td></tr>';
        }

        if (!recentUploads.children.length) {
          recentUploads.innerHTML =
            '<div class="text-muted">No recent uploads</div>';
        }
      }

      async function viewNote(filePath) {
        const {
          data: { publicUrl },
          error,
        } = await supabaseClient.storage.from("notes").getPublicUrl(filePath);

        if (error) {
          showAlert("Failed to get file URL", "danger");
          return;
        }

        window.open(publicUrl, "_blank");
      }

      function showAlert(message, type) {
        const alertDiv = document.createElement("div");
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
          ${message}
          <button type="button" class="close" data-dismiss="alert">&times;</button>
        `;
        document
          .querySelector(".card-body")
          .insertBefore(alertDiv, document.querySelector(".upload-form"));
        setTimeout(() => alertDiv.remove(), 3000);
      }

      async function initialize() {
        await initializeStorage();
        await Promise.all([loadAllNotes(), loadRecentUploads()]);
      }

      initialize();

      document
        .getElementById("uploadForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const semester = document.getElementById("semester").value;
          const subject = document.getElementById("subject").value;
          const file = document.getElementById("pdfFile").files[0];

          if (!file) {
            showAlert("Please select a file", "danger");
            return;
          }

          if (file.size > 5 * 1024 * 1024) {
            showAlert("File size must be less than 5MB", "danger");
            return;
          }

          if (!file.type.includes("pdf")) {
            showAlert("Only PDF files are allowed", "danger");
            return;
          }

          const cleanSubject = subject.replace(/[^a-zA-Z0-9]/g, "_");
          const cleanFileName = file.name.replace(/[^a-zA-Z0-9.]/g, "_");
          const fileName = `semester_${semester}/${cleanSubject}/${cleanFileName}`;

          try {
            const { data, error } = await supabaseClient.storage
              .from("notes")
              .upload(fileName, file, {
                cacheControl: "3600",
                upsert: true,
                contentType: "application/pdf",
              });

            if (error) throw error;

            const { error: dbError } = await supabaseClient
              .from("notes_metadata")
              .insert([
                {
                  semester,
                  subject: cleanSubject,
                  file_path: fileName,
                  file_name: cleanFileName,
                  is_public: true,
                },
              ]);

            if (dbError) throw dbError;

            showAlert("File uploaded successfully!", "success");
            document.getElementById("uploadForm").reset();
            await Promise.all([loadAllNotes(), loadRecentUploads()]);
          } catch (error) {
            console.error("Upload error:", error);
            showAlert(
              "Upload failed: " + (error.message || "Unknown error"),
              "danger"
            );
          }
        });

      document.getElementById("logoutBtn").addEventListener("click", (e) => {
        e.preventDefault();
        window.location.href = "../index.html";
      });
    </script>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="../js/admin.js"></script>
  </body>
</html>
